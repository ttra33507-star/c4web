{% extends "base.html" %}

{% block title %}Checkout &middot; C4{% endblock %}

{% set plans = pricing_plans if pricing_plans is defined else [] %}
{% set current_plan_id = service_id if service_id is defined else None %}

{% block head %}
{{ super() }}
<style>
    dialog[data-plan-modal] {
        padding: 0;
        border: none;
        background: transparent;
    }
    dialog[data-plan-modal]::backdrop {
        background: rgba(2, 6, 23, 0.85);
        backdrop-filter: blur(6px);
    }
    dialog[data-qr-modal] {
        padding: 0;
        border: none;
        background: transparent;
    }
    dialog[data-qr-modal]::backdrop {
        background: rgba(2, 6, 23, 0.85);
        backdrop-filter: blur(12px);
    }
</style>
{% endblock %}

{% block content %}
{% if plans %}
<section class="relative border-b border-slate-900/80 bg-slate-950/60">
    <div class="absolute inset-0 -z-10 bg-gradient-to-b from-emerald-900/40 via-slate-950/60 to-slate-950/90"></div>
    <div class="mx-auto w-full max-w-6xl px-4 py-20 sm:px-6 lg:px-8">
        <div class="text-center">
            <span class="inline-flex items-center justify-center rounded-full border border-emerald-300/30 bg-emerald-500/10 px-4 py-1 text-xs font-semibold uppercase tracking-[0.35em] text-emerald-200">
                Pricing
            </span>
            <h1 class="mt-6 text-4xl font-semibold text-white font-display sm:text-5xl">Choose Your Perfect Plan</h1>
            <p class="mt-4 text-base text-slate-300 sm:text-lg">
                Select the ideal package that fits your automation needs and scale your success.
            </p>
        </div>
        <div class="mt-14 grid gap-6 lg:grid-cols-3">
            {% for plan in plans %}
                {% set is_highlight = plan.variant == 'highlight' or (plan.service_id and plan.service_id == current_plan_id) %}
                {% set card_classes = 'relative flex flex-col rounded-3xl border border-emerald-400/60 bg-gradient-to-br from-emerald-700/30 via-emerald-600/20 to-slate-950/90 p-8 shadow-xl ring-1 ring-emerald-400/40' if is_highlight else 'relative flex flex-col rounded-3xl border border-slate-800/70 bg-slate-900/70 p-8 shadow-lg transition hover:border-emerald-400/40' %}
                {% set feature_text_class = 'text-emerald-100' if is_highlight else 'text-slate-300' %}
                {% set icon_class = 'text-emerald-300' if is_highlight else 'text-emerald-400' %}
                {% set price_suffix_class = 'text-emerald-200/90' if is_highlight else 'text-slate-400' %}
                {% set button_classes = 'mt-10 inline-flex items-center justify-center rounded-full bg-emerald-400 px-6 py-3 text-sm font-semibold text-slate-950 transition hover:bg-emerald-300' if is_highlight else 'mt-10 inline-flex items-center justify-center rounded-full bg-slate-800 px-6 py-3 text-sm font-semibold text-white transition hover:bg-slate-700' %}
                {% set plan_href = url_for('main.order_service', service_id=plan.service_id) if plan.service_id else url_for('main.contact') %}
                <article class="{{ card_classes }}">
                    {% if plan.badge %}
                        <span class="absolute -top-4 left-1/2 -translate-x-1/2 rounded-full bg-emerald-500 px-4 py-1 text-xs font-semibold uppercase tracking-[0.35em] text-slate-950">
                            {{ plan.badge }}
                        </span>
                    {% endif %}
                    <div class="text-sm font-semibold text-slate-300">{{ plan.title }}</div>
                    <div class="mt-4 flex items-baseline gap-2">
                        <span class="text-4xl font-semibold text-white">${{ plan.price_display }}</span>
                        <span class="text-sm {{ price_suffix_class }}">{{ plan.price_suffix }}</span>
                    </div>
                    <ul class="mt-8 space-y-3 text-sm {{ feature_text_class }}">
                        {% for feature in plan.features %}
                            <li class="flex items-center gap-2">
                                <svg class="h-4 w-4 {{ icon_class }}" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 00-1.414 0L8 12.586 4.707 9.293a1 1 0 10-1.414 1.414l4 4a1 1 0 001.414 0l8-8a1 1 0 000-1.414z" clip-rule="evenodd"/></svg>
                                {{ feature }}
                            </li>
                        {% endfor %}
                    </ul>
                    <button type="button"
                            class="{{ button_classes }}"
                            data-plan-open
                            data-plan-title="{{ plan.title }}"
                            data-plan-price="{{ plan.price_display }}"
                            data-plan-service-id="{{ plan.service_id if plan.service_id is not none else '' }}"
                            data-plan-href="{{ plan_href }}">
                        Get started
                    </button>
                </article>
            {% endfor %}
        </div>
    </div>
    <dialog id="plan-modal" data-plan-modal class="fixed left-1/2 top-1/2 z-50 w-full max-w-md -translate-x-1/2 -translate-y-1/2 transform">
        <div class="relative rounded-3xl border border-slate-800 bg-slate-950/95 p-8 text-center shadow-2xl">
            <button type="button" data-plan-close class="absolute right-4 top-4 inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700 bg-slate-900/80 text-slate-400 transition hover:text-white">
                <span class="sr-only">Close</span>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
            <h2 class="text-lg font-semibold text-white">Choose Payment Method</h2>
            <p class="mt-2 text-sm text-slate-400">Select your preferred payment method to complete the purchase.</p>
            <div class="mt-6 space-y-2">
                <div data-plan-modal-title class="text-sm font-semibold uppercase tracking-[0.3em] text-emerald-200"></div>
                <div data-plan-modal-price class="text-3xl font-semibold text-white"></div>
            </div>
            <button type="button" data-plan-pay class="mt-8 flex w-full items-center justify-center gap-3 rounded-2xl bg-white px-6 py-3 text-base font-semibold text-slate-900 transition hover:bg-slate-100">
                <span class="inline-flex items-center justify-center rounded-full bg-emerald-500/20 px-2 py-1 text-xs font-semibold uppercase tracking-widest text-emerald-600">
                    Pay
                </span>
                <span>Pay with ABA PayWay</span>
            </button>
        </div>
    </dialog>
    <dialog id="qr-modal" data-qr-modal class="fixed left-1/2 top-1/2 z-50 w-full max-w-md -translate-x-1/2 -translate-y-1/2 transform">
        <div class="relative rounded-3xl border border-emerald-400/30 bg-emerald-500/5 p-4 shadow-[0_40px_80px_-40px_rgba(9,107,159,0.65)]">
            <button type="button" data-qr-close class="absolute right-6 top-6 inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700 bg-slate-900/80 text-slate-300 transition hover:text-white">
                <span class="sr-only">Close</span>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
            <div class="rounded-3xl bg-white px-8 pb-8 pt-12 text-center text-slate-900 shadow-xl">
                <div class="mx-auto flex h-14 w-36 items-center justify-center rounded-2xl bg-gradient-to-r from-rose-500 via-red-500 to-rose-600 text-sm font-semibold uppercase tracking-[0.25em] text-white shadow-lg">
                    ABA KHQR
                </div>
                <div class="mt-6 space-y-1">
                    <div class="text-xs font-semibold uppercase tracking-[0.35em] text-slate-400" data-qr-plan-title></div>
                    <div class="text-3xl font-semibold text-slate-900" data-qr-plan-price></div>
                </div>
                <div class="mt-6 flex justify-center">
                    <div class="overflow-hidden rounded-2xl border border-slate-200 bg-white p-4 shadow-inner">
                        <img data-qr-image src="https://api.qrserver.com/v1/create-qr-code/?size=240x240&data=Pay%20with%20ABA%20PayWay" alt="ABA PayWay QR code" class="h-52 w-52 object-contain">
                    </div>
                </div>
                <p class="mt-6 text-xs text-slate-500">
                    Scan with ABA Mobile or any Khmer QR compatible banking app to confirm your payment instantly.
                </p>
                <button type="button" data-qr-proceed class="mt-8 w-full rounded-2xl bg-emerald-500 px-6 py-3 text-sm font-semibold text-slate-950 shadow-lg transition hover:bg-emerald-400">
                    Continue to secure checkout
                </button>
            </div>
        </div>
    </dialog>
</section>
{% endif %}

<section class="relative isolate overflow-hidden">
    <div class="absolute inset-0 -z-10 bg-gradient-to-br from-slate-950 via-slate-900 to-slate-950"></div>
    <div class="mx-auto flex w-full max-w-5xl flex-col gap-10 px-4 py-16 sm:px-6 lg:flex-row lg:px-8">
        <div class="flex-1 space-y-6">
            <header>
                <p class="text-xs uppercase tracking-[0.35em] text-emerald-200">Secure checkout</p>
                <h2 class="mt-3 text-4xl font-semibold text-white font-display">{{ service.name }}</h2>
                <p class="mt-4 text-sm leading-relaxed text-slate-300">
                    Complete your purchase using ABA PayWay. Once confirmed, a receipt and activation summary will be emailed to you.
                </p>
            </header>

            <div class="rounded-3xl border border-slate-900/80 bg-slate-900/50 p-6 shadow-2xl">
                <h3 class="text-sm uppercase tracking-[0.35em] text-slate-400">What's included</h3>
                <ul class="mt-4 space-y-3 text-sm text-slate-300">
                    <li class="flex items-center gap-3">
                        <span class="inline-flex h-6 w-6 items-center justify-center rounded-full bg-emerald-500/15 text-emerald-200">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                            </svg>
                        </span>
                        White-glove onboarding call
                    </li>
                    <li class="flex items-center gap-3">
                        <span class="inline-flex h-6 w-6 items-center justify-center rounded-full bg-emerald-500/15 text-emerald-200">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                            </svg>
                        </span>
                        12-month hardware coverage
                    </li>
                    <li class="flex items-center gap-3">
                        <span class="inline-flex h-6 w-6 items-center justify-center rounded-full bg-emerald-500/15 text-emerald-200">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                            </svg>
                        </span>
                        ABA PayWay secure payment handling
                    </li>
                </ul>
                <dl class="mt-6 flex items-center justify-between text-sm">
                    <dt class="text-slate-400">Subtotal</dt>
                    <dd class="font-semibold text-white">${{ "%.2f"|format(service.price) }}</dd>
                </dl>
                <dl class="mt-2 flex items-center justify-between text-sm">
                    <dt class="text-slate-400">Processing</dt>
                    <dd class="font-semibold text-white">$0.00</dd>
                </dl>
                <dl class="mt-4 flex items-center justify-between border-t border-slate-800 pt-4 text-sm">
                    <dt class="font-semibold text-slate-300">Total due today</dt>
                    <dd class="text-xl font-semibold text-emerald-300">${{ "%.2f"|format(service.price) }}</dd>
                </dl>
            </div>
        </div>

        <div class="flex-1">
            <form id="checkout-form" class="space-y-5 rounded-3xl border border-slate-900/80 bg-slate-900/60 p-8 shadow-2xl">
                <h3 class="text-lg font-semibold text-white">Billing contact</h3>
                <p class="text-sm text-slate-400">We'll send the payment confirmation and activation instructions here.</p>
                <div class="grid gap-4 sm:grid-cols-2">
                    <div class="sm:col-span-2">
                        <label for="fullName" class="text-xs uppercase tracking-[0.3em] text-slate-400">Full Name</label>
                        <input id="fullName" name="fullName" type="text" required placeholder="Your name"
                               class="mt-2 w-full rounded-xl border border-slate-800 bg-slate-950/70 px-4 py-2 text-sm text-white placeholder-slate-500 focus:border-emerald-400 focus:outline-none focus:ring-2 focus:ring-emerald-500/40">
                    </div>
                    <div>
                        <label for="email" class="text-xs uppercase tracking-[0.3em] text-slate-400">Email</label>
                        <input id="email" name="email" type="email" required placeholder="you@company.com"
                               class="mt-2 w-full rounded-xl border border-slate-800 bg-slate-950/70 px-4 py-2 text-sm text-white placeholder-slate-500 focus:border-emerald-400 focus:outline-none focus:ring-2 focus:ring-emerald-500/40">
                    </div>
                    <div>
                        <label for="phone" class="text-xs uppercase tracking-[0.3em] text-slate-400">Phone</label>
                        <input id="phone" name="phone" type="tel" placeholder="+855 xxx xxx xxx"
                               class="mt-2 w-full rounded-xl border border-slate-800 bg-slate-950/70 px-4 py-2 text-sm text-white placeholder-slate-500 focus:border-emerald-400 focus:outline-none focus:ring-2 focus:ring-emerald-500/40">
                    </div>
                </div>
                <div class="space-y-2 rounded-2xl border border-emerald-500/30 bg-emerald-500/5 p-4 text-sm text-emerald-200">
                    <div class="flex items-center gap-3">
                        <span class="inline-flex h-8 w-8 items-center justify-center rounded-full bg-emerald-500/15 text-emerald-200">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 5l7 7-7 7"/>
                            </svg>
                        </span>
                        ABA PayWay launches in a secure tab for authorization.
                    </div>
                    <p class="text-xs text-emerald-100/80">
                        After the gateway confirms payment, you'll be redirected back to C4 automatically.
                    </p>
                </div>
                <button type="submit" class="btn-primary w-full">
                    Pay {{ "%.2f"|format(service.price) }} with ABA PayWay
                </button>
                <p id="checkout-error" class="hidden text-sm text-rose-300"></p>
            </form>
        </div>
    </div>
</section>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    const planButtons = document.querySelectorAll('[data-plan-open]');
    const planModal = document.querySelector('[data-plan-modal]');
    const planModalTitle = planModal ? planModal.querySelector('[data-plan-modal-title]') : null;
    const planModalPrice = planModal ? planModal.querySelector('[data-plan-modal-price]') : null;
    const planPayButton = planModal ? planModal.querySelector('[data-plan-pay]') : null;
    const planCloseButtons = planModal ? planModal.querySelectorAll('[data-plan-close]') : [];
    const qrModal = document.querySelector('[data-qr-modal]');
    const qrPlanTitle = qrModal ? qrModal.querySelector('[data-qr-plan-title]') : null;
    const qrPlanPrice = qrModal ? qrModal.querySelector('[data-qr-plan-price]') : null;
    const qrImage = qrModal ? qrModal.querySelector('[data-qr-image]') : null;
    const qrCloseButtons = qrModal ? qrModal.querySelectorAll('[data-qr-close]') : [];
    const qrProceedButton = qrModal ? qrModal.querySelector('[data-qr-proceed]') : null;
    const qrProceedDefaultLabel = qrProceedButton ? qrProceedButton.textContent : '';
    const currentServiceId = {{ service_id | tojson }};
    const checkoutForm = document.getElementById('checkout-form');

    let activePlanHref = null;
    let activePlanServiceId = null;
    let activePlanTitle = null;
    let activePlanPrice = null;
    let qrNextAction = 'form';
    let qrNextHref = null;

    const formatPrice = value => {
        if (value === null || value === undefined || value === '') {
            return '';
        }
        if (typeof value === 'number' && Number.isFinite(value)) {
            return `$${value.toFixed(2)}`;
        }
        const numeric = Number(value);
        if (!Number.isNaN(numeric)) {
            return `$${numeric.toFixed(2)}`;
        }
        const stringValue = String(value).trim();
        return stringValue.startsWith('$') ? stringValue : `$${stringValue}`;
    };

    const fallbackPrice = '{{ "%.2f"|format(service.price) }}';

    const openQrModal = () => {
        if (!qrModal) {
            return;
        }
        const displayTitle = activePlanTitle || 'Selected Plan';
        const displayPrice = formatPrice(activePlanPrice || fallbackPrice);

        if (qrPlanTitle) {
            qrPlanTitle.textContent = displayTitle;
        }
        if (qrPlanPrice) {
            qrPlanPrice.textContent = displayPrice ? `${displayPrice} USD` : '';
        }
        if (qrImage) {
            const qrData = `${displayTitle} | ${displayPrice}`;
            qrImage.src = `https://api.qrserver.com/v1/create-qr-code/?size=240x240&data=${encodeURIComponent(qrData)}`;
            qrImage.alt = `ABA PayWay QR code for ${displayTitle} ${displayPrice}`;
        }
        if (qrProceedButton) {
            if (qrNextAction === 'navigate' && qrNextHref) {
                qrProceedButton.textContent = 'Continue to this plan checkout';
            } else {
                qrProceedButton.textContent = qrProceedDefaultLabel || 'Continue to secure checkout';
            }
        }

        if (typeof qrModal.showModal === 'function') {
            qrModal.showModal();
        }
    };

    if (planButtons.length && planModal) {
        planButtons.forEach(button => {
            button.addEventListener('click', () => {
                const { planTitle, planPrice, planHref, planServiceId } = button.dataset;
                activePlanHref = planHref || null;
                activePlanServiceId = planServiceId || null;
                activePlanTitle = planTitle || null;
                activePlanPrice = planPrice || null;

                if (planModalTitle) {
                    planModalTitle.textContent = activePlanTitle || '';
                }
                if (planModalPrice) {
                    planModalPrice.textContent = formatPrice(activePlanPrice);
                }

                if (typeof planModal.showModal === 'function') {
                    planModal.showModal();
                }
            });
        });

        planCloseButtons.forEach(button => {
            button.addEventListener('click', () => {
                planModal.close();
            });
        });

        planModal.addEventListener('cancel', event => {
            event.preventDefault();
            planModal.close();
        });

        planModal.addEventListener('click', event => {
            if (event.target === planModal) {
                planModal.close();
            }
        });
    }

    if (planPayButton) {
        planPayButton.addEventListener('click', () => {
            const isCurrentPlan = activePlanServiceId !== null
                && currentServiceId !== null
                && String(activePlanServiceId) === String(currentServiceId);
            qrNextAction = 'form';
            qrNextHref = null;
            if (!isCurrentPlan && activePlanHref) {
                qrNextAction = 'navigate';
                qrNextHref = activePlanHref;
            }

            if (isCurrentPlan) {
                planModal.close();
            } else {
                if (planModal.hasAttribute('open')) {
                    planModal.close();
                }
            }

            if (qrModal) {
                openQrModal();
            } else if (qrNextAction === 'navigate' && qrNextHref) {
                window.location.href = qrNextHref;
            } else if (checkoutForm) {
                checkoutForm.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        });
    }

    if (qrModal) {
        qrCloseButtons.forEach(button => {
            button.addEventListener('click', () => {
                qrModal.close();
            });
        });

        qrModal.addEventListener('cancel', event => {
            event.preventDefault();
            qrModal.close();
        });

        qrModal.addEventListener('click', event => {
            if (event.target === qrModal) {
                qrModal.close();
            }
        });

        if (qrProceedButton && checkoutForm) {
            qrProceedButton.addEventListener('click', () => {
                qrModal.close();
                if (qrNextAction === 'navigate' && qrNextHref) {
                    window.location.href = qrNextHref;
                    return;
                }
                if (checkoutForm) {
                    checkoutForm.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    if (checkoutForm.fullName) {
                        checkoutForm.fullName.focus();
                    }
                } else if (qrNextHref) {
                    window.location.href = qrNextHref;
                }
            });
        }
    }

    const form = document.getElementById('checkout-form');
    const errorBanner = document.getElementById('checkout-error');

    async function handleCheckout(event) {
        event.preventDefault();
        errorBanner.classList.add('hidden');

        const submitButton = form.querySelector('button[type="submit"]');
        submitButton.setAttribute('disabled', 'disabled');
        submitButton.textContent = 'Redirecting to PayWay...';

        try {
            const response = await fetch("{{ url_for('api.payway_checkout') }}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    serviceId: {{ service_id }},
                    customer: {
                        name: form.fullName.value,
                        email: form.email.value,
                        phone: form.phone.value,
                    },
                }),
            });

            if (!response.ok) {
                throw new Error(`Gateway request failed (${response.status})`);
            }

            const { endpoint, payload } = await response.json();

            const gatewayForm = document.createElement('form');
            gatewayForm.method = 'POST';
            gatewayForm.action = endpoint;
            gatewayForm.className = 'hidden';

            Object.entries(payload).forEach(([key, value]) => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = key;
                input.value = value;
                gatewayForm.appendChild(input);
            });

            document.body.appendChild(gatewayForm);
            gatewayForm.submit();
        } catch (error) {
            console.error(error);
            errorBanner.textContent = 'Unable to start the PayWay checkout. Please retry or contact support.';
            errorBanner.classList.remove('hidden');
            submitButton.removeAttribute('disabled');
            submitButton.textContent = 'Pay {{ "%.2f"|format(service.price) }} with ABA PayWay';
        }
    }

    form.addEventListener('submit', handleCheckout);
</script>
{% endblock %}
