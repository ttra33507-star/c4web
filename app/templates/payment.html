{% extends "base.html" %}

{% block title %}Checkout &middot; FARMREEL{% endblock %}

{% block content %}
<section class="relative isolate overflow-hidden">
    <div class="absolute inset-0 -z-10 bg-gradient-to-br from-slate-950 via-slate-900 to-slate-950"></div>
    <div class="mx-auto flex w-full max-w-5xl flex-col gap-10 px-4 py-16 sm:px-6 lg:flex-row lg:px-8">
        <div class="flex-1 space-y-6">
            <header>
                <p class="text-xs uppercase tracking-[0.35em] text-emerald-200">Secure checkout</p>
                <h1 class="mt-3 text-4xl font-semibold text-white font-display">{{ service.name }}</h1>
                <p class="mt-4 text-sm leading-relaxed text-slate-300">
                    Complete your purchase using ABA PayWay. Once confirmed, a receipt and activation summary will be emailed to you.
                </p>
            </header>

            <div class="rounded-3xl border border-slate-900/80 bg-slate-900/50 p-6 shadow-2xl">
                <h2 class="text-sm uppercase tracking-[0.35em] text-slate-400">What's included</h2>
                <ul class="mt-4 space-y-3 text-sm text-slate-300">
                    <li class="flex items-center gap-3">
                        <span class="inline-flex h-6 w-6 items-center justify-center rounded-full bg-emerald-500/15 text-emerald-200">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                            </svg>
                        </span>
                        White-glove onboarding call
                    </li>
                    <li class="flex items-center gap-3">
                        <span class="inline-flex h-6 w-6 items-center justify-center rounded-full bg-emerald-500/15 text-emerald-200">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                            </svg>
                        </span>
                        12-month hardware coverage
                    </li>
                    <li class="flex items-center gap-3">
                        <span class="inline-flex h-6 w-6 items-center justify-center rounded-full bg-emerald-500/15 text-emerald-200">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                            </svg>
                        </span>
                        ABA PayWay secure payment handling
                    </li>
                </ul>
                <dl class="mt-6 flex items-center justify-between text-sm">
                    <dt class="text-slate-400">Subtotal</dt>
                    <dd class="font-semibold text-white">${{ "%.2f"|format(service.price) }}</dd>
                </dl>
                <dl class="mt-2 flex items-center justify-between text-sm">
                    <dt class="text-slate-400">Processing</dt>
                    <dd class="font-semibold text-white">$0.00</dd>
                </dl>
                <dl class="mt-4 flex items-center justify-between border-t border-slate-800 pt-4 text-sm">
                    <dt class="font-semibold text-slate-300">Total due today</dt>
                    <dd class="text-xl font-semibold text-emerald-300">${{ "%.2f"|format(service.price) }}</dd>
                </dl>
            </div>
        </div>

        <div class="flex-1">
            <form id="checkout-form" class="space-y-5 rounded-3xl border border-slate-900/80 bg-slate-900/60 p-8 shadow-2xl">
                <h2 class="text-lg font-semibold text-white">Billing contact</h2>
                <p class="text-sm text-slate-400">We'll send the payment confirmation and activation instructions here.</p>
                <div class="grid gap-4 sm:grid-cols-2">
                    <div class="sm:col-span-2">
                        <label for="fullName" class="text-xs uppercase tracking-[0.3em] text-slate-400">Full Name</label>
                        <input id="fullName" name="fullName" type="text" required placeholder="Your name"
                               class="mt-2 w-full rounded-xl border border-slate-800 bg-slate-950/70 px-4 py-2 text-sm text-white placeholder-slate-500 focus:border-emerald-400 focus:outline-none focus:ring-2 focus:ring-emerald-500/40">
                    </div>
                    <div>
                        <label for="email" class="text-xs uppercase tracking-[0.3em] text-slate-400">Email</label>
                        <input id="email" name="email" type="email" required placeholder="you@company.com"
                               class="mt-2 w-full rounded-xl border border-slate-800 bg-slate-950/70 px-4 py-2 text-sm text-white placeholder-slate-500 focus:border-emerald-400 focus:outline-none focus:ring-2 focus:ring-emerald-500/40">
                    </div>
                    <div>
                        <label for="phone" class="text-xs uppercase tracking-[0.3em] text-slate-400">Phone</label>
                        <input id="phone" name="phone" type="tel" placeholder="+855 xxx xxx xxx"
                               class="mt-2 w-full rounded-xl border border-slate-800 bg-slate-950/70 px-4 py-2 text-sm text-white placeholder-slate-500 focus:border-emerald-400 focus:outline-none focus:ring-2 focus:ring-emerald-500/40">
                    </div>
                </div>
                <div class="space-y-2 rounded-2xl border border-emerald-500/30 bg-emerald-500/5 p-4 text-sm text-emerald-200">
                    <div class="flex items-center gap-3">
                        <span class="inline-flex h-8 w-8 items-center justify-center rounded-full bg-emerald-500/15 text-emerald-200">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 5l7 7-7 7"/>
                            </svg>
                        </span>
                        ABA PayWay launches in a secure tab for authorization.
                    </div>
                    <p class="text-xs text-emerald-100/80">
                        After the gateway confirms payment, you'll be redirected back to FARMREEL automatically.
                    </p>
                </div>
                <button type="submit" class="btn-primary w-full">
                    Pay {{ "%.2f"|format(service.price) }} with ABA PayWay
                </button>
                <p id="checkout-error" class="hidden text-sm text-rose-300"></p>
            </form>
        </div>
    </div>
</section>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    const form = document.getElementById('checkout-form');
    const errorBanner = document.getElementById('checkout-error');

    async function handleCheckout(event) {
        event.preventDefault();
        errorBanner.classList.add('hidden');

        const submitButton = form.querySelector('button[type="submit"]');
        submitButton.setAttribute('disabled', 'disabled');
        submitButton.textContent = 'Redirecting to PayWay...';

        try {
            const response = await fetch("{{ url_for('main.payway_checkout') }}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    serviceId: {{ service_id }},
                    customer: {
                        name: form.fullName.value,
                        email: form.email.value,
                        phone: form.phone.value,
                    },
                }),
            });

            if (!response.ok) {
                throw new Error(`Gateway request failed (${response.status})`);
            }

            const { endpoint, payload } = await response.json();

            const gatewayForm = document.createElement('form');
            gatewayForm.method = 'POST';
            gatewayForm.action = endpoint;
            gatewayForm.className = 'hidden';

            Object.entries(payload).forEach(([key, value]) => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = key;
                input.value = value;
                gatewayForm.appendChild(input);
            });

            document.body.appendChild(gatewayForm);
            gatewayForm.submit();
        } catch (error) {
            console.error(error);
            errorBanner.textContent = 'Unable to start the PayWay checkout. Please retry or contact support.';
            errorBanner.classList.remove('hidden');
            submitButton.removeAttribute('disabled');
            submitButton.textContent = 'Pay {{ "%.2f"|format(service.price) }} with ABA PayWay';
        }
    }

    form.addEventListener('submit', handleCheckout);
</script>
{% endblock %}
